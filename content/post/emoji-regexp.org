#+title: Emoji æ­£åˆ™åŒ¹é…
#+date: 2024-05-09T20:28:46+08:00
#+lastmod: 2024-05-09T20:28:46+08:00
#+draft: true
#+keywords[]:
#+description: ""
#+tags[]:
#+categories[]:

* å‰è¨€

è¦æ±‚è¾“å…¥æ¡†èƒ½è¾“å…¥é™¤äº†ç‰¹æ®Šè¡¨æƒ…å¤–çš„ä»»æ„å­—ç¬¦ã€‚

æˆ‘çš„ç†è§£å°±æ˜¯å°† Emoji æ’é™¤æ‰ï¼Œé€šè¿‡ [[https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp][RegExp]] åŒ¹é…åˆ° Emojiï¼Œå¦‚æœåŒ¹é…åˆ°åˆ™è¯´æ˜å­˜åœ¨ç‰¹æ®Šå­—ç¬¦ï¼ŒåŒ¹é…ä¸åˆ°åˆ™è®¤ä¸ºé€šè¿‡ã€‚

* TL;DR

å¦‚æœä½ åªæ˜¯æƒ³è¦ä¸€ä¸ªèƒ½å¤ŸåŒ¹é…è¡¨æƒ…çš„æ­£åˆ™ï¼Œä¸‹é¢è¿™ä¸ªåº”è¯¥å°±æ»¡è¶³ğŸ‘‡ï¼š

#+begin_src typescript
    /\p{Extended_Pictographic}/gu.test("ä½ å¥½hello123ğŸ˜„hiğŸŒ·456ğŸ‰") // true
    /\p{Extended_Pictographic}/gu.test("ä½ å¥½hello123") // false
#+end_src

[[file:/post/emoji-regexp/regexp101-emoji-corret.png]]

* è§£å†³è¿‡ç¨‹

å¯¹äº Emoji è¿™ç§æ­£åˆ™ï¼Œä¸€å¼€å§‹æƒ³ä¸åˆ°å¦‚ä½•æ„å»ºï¼Œç†è®ºä¸Šå®ƒä¹Ÿæ˜¯å±äº Stringï¼Œå¤§è‡´çŸ¥é“æ˜¯ç”¨ Unicode ç¼–ç è¡¨ç¤ºçš„ï¼Œä½†æ€ä¹ˆç”¨æ­£åˆ™æè¿°å®ƒå‘¢ï¼Ÿ

æ‰€ä»¥æˆ‘çš„ç¬¬ä¸€æ­¥æ˜¯ Googleï¼Œå¾—åˆ°ä¸€ä¸ªè¿™æ ·çš„æ­£åˆ™ï¼š

#+begin_src typescript
    /(\ud83c[\udf00-\udfff])|(\ud83d[\udc00-\ude4f\ude80-\udeff])|[\u2600-\u2B55]/
#+end_src

æ‹¿å» [[https://regex101.com/][regex101]] æµ‹è¯•äº†ä¸€ä¸‹ï¼Œè™½ç„¶èƒ½åŒ¹é…åˆ°ä¸€äº› Emojiï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰éƒ¨åˆ† Emoji åŒ¹é…ä¸åˆ°ã€‚

[[file:/post/emoji-regexp/regexp101-emoji-wrong.png]]

ä¸Šé¢çš„æ­£åˆ™è¡¨è¾¾å¼åº”è¯¥æ˜¯è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ª Unicode å­—ç¬¦èŒƒå›´ï¼Œéƒ¨åˆ† Emoji (ğŸ‰)æ²¡åŒ¹é…ä¸Šï¼Œè¯´æ˜è¿™ä¸ªèŒƒå›´å°äº†ï¼Œæ²¡æœ‰å›Šæ‹¬æ‰€æœ‰çš„ Emojiã€‚

é‚£ä¹ˆ Emoji çš„ Unicode èŒƒå›´æ˜¯å¤šå°‘ï¼Ÿæ˜¯ä¸æ˜¯ç©·ä¸¾å°±è¡Œäº†ï¼Ÿ

å…¶å®æ²¡åŠæ³•ç”¨ä¸€ä¸ªå›ºå®šçš„èŒƒå›´å»è¡¨è¾¾ï¼Œå› ä¸º Emoji æ˜¯æŒç»­å¢åŠ çš„ï¼Œæ¯å¢åŠ ä¸€ä¸ªå°±ä¼šå¤šä¸€ä¸ª Unicode å»æ‰¿è½½ï¼Œæ²¡åŠæ³•ç”¨ä¸€ä¸ªå›ºå®šçš„èŒƒå›´å»è¡¨è¾¾æ‰€æœ‰çš„ Emojiã€‚

äºæ˜¯åˆæœç´¢äº†ä¸€ä¸‹ï¼ŒStackOverflow æœ‰ä¸€ä¸ª[[https://stackoverflow.com/questions/18862256/how-to-detect-emoji-using-javascript][æé—®]]ï¼Œé‡Œé¢æåˆ°äº†ç”¨ [[https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Regular_expressions/Unicode_character_class_escape][Unicode character class escape]] è¿›è¡ŒåŒ¹é…ï¼Œä¹Ÿå°±æ˜¯:

- ~/\p{Emoji}/u~ :: æ—¢ç„¶æ˜¯åŒ¹é… Emojiï¼Œé‚£ä¹ˆ loneProperty å°±åº”è¯¥æ˜¯ Emoji ? å®é™…æµ‹è¯•å¹¶ä¸ç¬¦åˆéœ€æ±‚ï¼Œå› ä¸ºåœ¨ [[https://www.unicode.org/Public/15.1.0/ucd/emoji/emoji-data.txt][Emoji å®˜æ–¹æ–‡æ¡£]]ä¸­ï¼Œ =123456789*#= ä¹Ÿæ˜¯è¢«çœ‹ä½œæ˜¯ Emojiï¼Œ
  å¦‚æœç”¨è¿™ä¸ªæ­£åˆ™çš„è¯ï¼Œå°±ä¼šæŠŠæ•°å­—ä¹Ÿè®¤ä¸ºæ˜¯ Emojiï¼Œä¸ç¬¦åˆåªæ’é™¤ç‰¹æ®Šè¡¨æƒ…çš„æ¡ä»¶ã€‚

- ~/\p{Extended_Pictographic}/u~ :: è€Œ Extended_Pictographic è¡¨ç¤ºçš„ Emoji æ‰æ˜¯æˆ‘ä»¬è®¤ä¸ºçš„é‚£äº›è¡¨æƒ…ç¬¦å·ã€‚

#+begin_src typescript
  console.log(
    /\p{Emoji}/u.test('flowers'), // false :)
    /\p{Emoji}/u.test('flowers ğŸŒ¼ğŸŒºğŸŒ¸'), // true :)
    /\p{Emoji}/u.test('flowers 123'), // true :(
  )
  console.log(
    /\p{Extended_Pictographic}/u.test('flowers'), // false :)
    /\p{Extended_Pictographic}/u.test('flowers ğŸŒ¼ğŸŒºğŸŒ¸'), // true :)
    /\p{Extended_Pictographic}/u.test('flowers 123'), // false :)
  )
#+end_src

* Unicode character class escpae

[[https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Regular_expressions/Unicode_character_class_escape][Unicode character class escape: \p{...}, \P{...}]] æ˜¯ [[https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Regular_expressions/Character_class_escape][Character class escape]] ä¸­çš„ä¸€ç§ã€‚

å¹³æ—¶æ­£åˆ™ä¸­å¸¸ç”¨çš„ \d,\D,\w,\W å°±æ˜¯ Character class escapeï¼Œå°±æ˜¯ç”¨æ¥è¡¨è¾¾ä¸€ç»„å­—ç¬¦çš„è½¬ä¹‰åºåˆ—(escape sequence)ã€‚

ä¾‹å¦‚ =\d= è¡¨è¾¾çš„å°±æ˜¯ =[0-9]=  ã€‚

è€Œ =\p{...}= , =\P{...}= ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œåªæ˜¯ä»–ä»¬ç”¨æ¥è¡¨è¾¾ä¸€ç»„ Unicdoe å­—ç¬¦ï¼Œé€šè¿‡æŒ‡å®š [[https://tc39.es/ecma262/multipage/text-processing.html#sec-runtime-semantics-unicodematchproperty-p][Unicode property]] å†³å®šåŒ¹é…ä»€ä¹ˆ Unicodeã€‚

ä¾‹å¦‚å¯ä»¥ç”¨ =/\p{Hex_Digit}/u= å»åŒ¹é… 16 è¿›åˆ¶çš„å­—ç¬¦ï¼š

[[file:/post/emoji-regexp/regexp101-emoji-hex-digit.png]]

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨ Unicode character class escpae è¦å¯ç”¨ [[https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp/unicode#unicode-aware_mode][unicode-aware mode]]ï¼Œå³åŠ ä¸Š =/u= æ ‡è®°ã€‚

* String & Unicode

#+begin_quote
Strings are represented fundamentally as sequences of [[https://en.wikipedia.org/wiki/UTF-16][UTF-16]] code
units. In UTF-16 encoding, every code unit is exact 16 bits long. This
means there are a maximum of 2^16, or 65536 possible characters
representable as single UTF-16 code units.

...

However, the entire Unicode character set is much, much bigger
than 65536. The extra characters are stored in UTF-16 as surrogate
pairs, which are pairs of 16-bit code units that represent a single
character.To avoid ambiguity, the two parts of the pair must be
between 0xD800 and 0xDFFF, and these code units are not used to encode
single-code-unit characters. (More precisely, leading surrogates, also
called *high-surrogate* code units, have values between *0xD800 and
0xDBFF*, inclusive, while trailing surrogates, also called
*low-surrogate* code units, have values between *0xDC00 and 0xDFFF*,
inclusive.) Each Unicode character, comprised of one or two UTF-16
code units, is also called a *Unicode code point*. Each Unicode code
point can be written in a string with \u{xxxxxx} where xxxxxx
represents 1â€“6 hex digits.

â€”â€” [[https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String#utf-16_characters_unicode_code_points_and_grapheme_clusters][UTF-16 characters, Unicode code points, and grapheme clusters]]
#+end_quote

åœ¨ JavaScript ä¸­ï¼ŒString æ˜¯ UTF-16 (16-bit Unicode Transformation Format) ç¼–ç çš„ï¼Œå®ƒä»¥ 16 ä½å»è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼ˆcode unitï¼‰ï¼Œæœ€å¤šå¯ä»¥è¡¨ç¤º 65536 ä¸ªå­—ç¬¦ã€‚

è¿™ 65535 ä¸ªå­—ç¬¦ä¸­åŒ…å«äº†å¤§éƒ¨åˆ†å¸¸ç”¨å­—ç¬¦ï¼Œä¾‹å¦‚å­—æ¯ï¼Œæ•°å­—ï¼Œæ‹‰ä¸å­—ç¬¦ï¼Œä»¥åŠä¸€äº›ä¸œäºšæ–‡å­—å­—ç¬¦ã€‚

ä½†æ˜¯åæ¥å‘ç° 65535 å¹¶ä¸è¶³ä»¥è¡¨è¾¾æ‰€æœ‰å­—ç¬¦ï¼Œ16 ä½ä¸å¤Ÿï¼Œå°±æ‰©å¤§åˆ°äº† 20 ä½ã€‚

è§„å®šå‰ 10 ä½ä½œä¸º *é«˜ä»£ç†ä½ (high-surrogate)* ï¼Œå–å€¼èŒƒå›´æ˜¯ 0xD800 - 0xDBFFã€‚

å 10 ä½ä¸º *ä½ä»£ç†ä½ (low-surrogate)* ï¼Œå–å€¼èŒƒå›´æ˜¯ 0xDC00 - 0xDFFFã€‚

é«˜ä»£ç†ä½å’Œä½ä»£ç†ä½ç»„æˆ *ä»£ç†å¯¹ (surrogate pairs)* ã€‚

ç”±äºæœ‰ 20 ä½çš„é•¿åº¦ï¼Œå› æ­¤å¯ä»¥è¡¨è¾¾ 1048576 ä¸ªå­—ç¬¦ï¼Œä¹Ÿå°±æ˜¯å¤šå¯ä»¥åœ¨åŸæ¥ 65536 ä¸ªå­—ç¬¦ä¹‹ä¸Šï¼Œå†å¢åŠ  1048576 ä¸ªè¡¥å……å­—ç¬¦ã€‚

ä¸ºä»€ä¹ˆ Unicode è¦è¿™ä¹ˆè®¾è®¡ï¼Œå¯ä»¥å‚è€ƒ [[https://stackoverflow.com/questions/42181070/why-does-code-points-between-ud800-and-udbff-generate-one-length-string-in-ecm][Why does code points between U+D800 and U+DBFF generate one-length string in ECMAScript 6?]]

ä¸ºä»€ä¹ˆé«˜ä»£ç†å’Œä½ä»£ç†è¿™ä¹ˆå–å€¼ï¼Œå¯ä»¥å‚è€ƒ [[https://stackoverflow.com/questions/5178202/how-was-the-position-of-the-surrogates-area-utf-16-chosen][How was the position of the Surrogates Area (UTF-16) chosen?]]ï¼‰

*æ¦‚æ‹¬æ¥è¯´ï¼Œå°±æ˜¯åœ¨ JavaScript çš„ String ä¸­å¸¸ç”¨çš„å­—ç¬¦ï¼ˆå¦‚å­—æ¯ï¼Œæ•°å­—ï¼Œæ±‰å­—ï¼‰å¯ä»¥ç”¨ 1 ä¸ª UTF-16 ç¼–ç å•å…ƒè¡¨ç¤ºï¼Œä½†æ˜¯è¶…å‡º 65535 (0xFFFF, U+FFFF, \uFFFF) å­—ç¬¦ï¼ˆå¦‚ Emojiï¼‰ï¼Œå°±éœ€è¦ç”±ä»£ç†å¯¹è¡¨ç¤ºï¼ˆé«˜ä»£ç†+ä½ä»£ç†ï¼Œ2 ä¸ª UTF-16 ç¼–ç å•å…ƒï¼‰ã€‚*

* Refs

- [[https://stackoverflow.com/questions/18862256/how-to-detect-emoji-using-javascript][How to detect emoji using javascript]]

- [[https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Regular_expressions/Unicode_character_class_escape][Unicode character class escape: \p{...}, \P{...}]]

- [[https://tc39.es/ecma262/multipage/text-processing.html#table-binary-unicode-properties][Binary Unicode property aliases and their canonical property names]]
